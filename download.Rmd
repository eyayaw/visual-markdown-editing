---
output: 
  github_document: default
params:
   version: "1.4.419"
   win_version: "1.4.416"
knit: (function(input, ...) {
    rmarkdown::render(input); file.rename("download.md", "docs/_download.md")
  })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r}
library(plyr)
library(jsonlite)
library(urltools)
library(parsedate)

base_url <- "https://s3.amazonaws.com/rstudio-ide-build/desktop"

windows <- list(
   platform = "Windows 10/8/7",
   dir = "windows",
   file = "RStudio-%s.exe"
)

mac <- list(
   platform = "MacOS 10.13+",
   dir = "macos",
   file = "RStudio-%s.dmg"
)

ubuntu <- list(
   platform = "Ubuntu 18/Debian 10",
   dir = "bionic/amd64",
   file = "rstudio-%s-amd64.deb"
)

redhat <- list(
   platform = "Fedora 28/Red Hat 8",
   dir = "centos8/x86_64",
   file = "rstudio-%s-x86_64.rpm"
)

platforms <- list(windows, mac, ubuntu, redhat)

download_info <- lapply(platforms, function(platform) {
   version <- ifelse(platform$dir == "windows", params$win_version, params$version)
   platform$file <- sprintf(platform$file, version)
   platform$url <- paste(base_url, platform$dir, platform$file, sep = "/")
   platform$link <- paste0(
      "<a href=\"", platform$url, "\">", 
      "<i class=\"fa fa-download\"></i> ", platform$file, 
      "</a>"
   )
   aws_md5_url <- paste0(
      "https://eb7fgjmu47.execute-api.us-east-1.amazonaws.com/prod/md5?url=",
      urltools::url_encode(platform$url)
   )
   md5_info <- jsonlite::fromJSON(aws_md5_url)
   date <- parse_date(md5_info$last_modified)
   md5_info$date <- format.Date(date, format = "%m/%d/%y %H:%M %Z")
   c(platform, md5_info) 
})

downloads <- ldply(download_info, data.frame, stringsAsFactors = FALSE)

knitr::kable(
   downloads[,c("platform", "link", "md5")], 
   col.names = c("Platform", "Download", "MD5")
)
```

